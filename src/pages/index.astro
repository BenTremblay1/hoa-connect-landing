---
import PageLayout from '~/layouts/PageLayout.astro';

const metadata = {
  title: 'The Complaint Portal Built for Self-Managed HOAs',
  ignoreTitleTemplate: true,
  description:
    'Track complaints, manage violations, and keep residents informed without enterprise bloat. Built for self-managed HOAs with 50-200 units.',
};
---

<PageLayout metadata={metadata}>
  <section class="relative">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 pt-14 pb-16 md:pt-20 md:pb-20">
      <div class="grid lg:grid-cols-2 gap-10 items-center">
        <div>
          <p class="text-sm uppercase tracking-[0.2em] text-sky-600 font-semibold">HOA Connect</p>
          <h1 class="mt-4 text-4xl sm:text-5xl lg:text-6xl font-bold tracking-tight text-slate-900">
            The Complaint Portal Built for Self-Managed HOAs
          </h1>
          <p class="mt-6 text-lg text-slate-600 max-w-2xl">
            Track complaints, manage violations, and send transparent updates from one place. Purpose-built for
            volunteer-led communities with 50-200 units.
          </p>
          <div class="mt-8 flex flex-wrap gap-3">
            <a
              href="#join-waitlist"
              data-track-cta="hero_primary"
              class="inline-flex items-center justify-center rounded-lg bg-sky-600 px-6 py-3 text-sm font-semibold text-white hover:bg-sky-500"
            >
              Join the Waitlist
            </a>
            <a
              href="#features"
              class="inline-flex items-center justify-center rounded-lg border border-slate-300 px-6 py-3 text-sm font-semibold text-slate-700 hover:bg-slate-50"
            >
              See How It Works
            </a>
          </div>
          <p class="mt-5 text-sm text-slate-500">
            Validation goal: 100+ waitlist signups in 30 days from self-managed boards.
          </p>
        </div>

        <div class="rounded-2xl border border-slate-200 bg-white shadow-sm p-6 sm:p-8" id="join-waitlist">
          <h2 class="text-xl font-semibold text-slate-900">Get Early Access</h2>
          <p class="mt-2 text-sm text-slate-600">
            Join the founding waitlist and get launch pricing updates as soon as HOA Connect opens beta.
          </p>

          <form class="js-waitlist-form mt-6 space-y-4" novalidate>
            <div>
              <label for="waitlist-email-hero" class="block text-sm font-medium text-slate-800">Email</label>
              <input
                id="waitlist-email-hero"
                name="email"
                type="email"
                autocomplete="email"
                required
                placeholder="board@yourhoa.org"
                class="mt-1 w-full rounded-lg border border-slate-300 px-4 py-3 text-slate-900 placeholder:text-slate-400 focus:border-sky-500 focus:outline-none"
              />
            </div>
            <div class="grid sm:grid-cols-2 gap-4">
              <div>
                <label for="waitlist-role-hero" class="block text-sm font-medium text-slate-800">Role (optional)</label>
                <select
                  id="waitlist-role-hero"
                  name="role"
                  class="mt-1 w-full rounded-lg border border-slate-300 px-4 py-3 text-slate-900 focus:border-sky-500 focus:outline-none"
                >
                  <option value="">Select role</option>
                  <option value="board_member">Board member</option>
                  <option value="resident">Resident</option>
                  <option value="property_manager">Property manager</option>
                </select>
              </div>
              <div>
                <label for="waitlist-size-hero" class="block text-sm font-medium text-slate-800"
                  >HOA size (optional)</label
                >
                <select
                  id="waitlist-size-hero"
                  name="hoa_size"
                  class="mt-1 w-full rounded-lg border border-slate-300 px-4 py-3 text-slate-900 focus:border-sky-500 focus:outline-none"
                >
                  <option value="">Select size</option>
                  <option value="1-25">1-25 units</option>
                  <option value="26-50">26-50 units</option>
                  <option value="51-100">51-100 units</option>
                  <option value="101-200">101-200 units</option>
                  <option value="201+">201+ units</option>
                </select>
              </div>
            </div>

            <button
              type="submit"
              data-track-cta="waitlist_submit_hero"
              class="w-full rounded-lg bg-sky-600 px-4 py-3 font-semibold text-white hover:bg-sky-500 disabled:opacity-60"
            >
              Join Waitlist
            </button>
            <p class="js-form-message text-sm min-h-[1.25rem] text-slate-600" aria-live="polite"></p>
          </form>
        </div>
      </div>
    </div>
  </section>

  <section id="features" class="border-y border-slate-200 bg-slate-50/60">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 py-16 md:py-20">
      <div class="max-w-3xl">
        <p class="text-sm uppercase tracking-[0.2em] text-sky-600 font-semibold">Why Boards Switch</p>
        <h2 class="mt-3 text-3xl md:text-4xl font-bold text-slate-900">Stop losing complaints in inbox chaos</h2>
        <p class="mt-4 text-slate-600">
          Research with HOA communities shows the same pattern: complaints disappear in email threads, residents feel
          ignored, and volunteer board members burn out trying to keep up.
        </p>
      </div>

      <div class="mt-10 grid md:grid-cols-2 gap-5">
        <article class="rounded-xl border border-slate-200 bg-white p-6">
          <h3 class="text-lg font-semibold text-slate-900">Scattered communication</h3>
          <p class="mt-2 text-slate-600">
            Requests arrive via calls, texts, and emails with no central source of truth.
          </p>
        </article>
        <article class="rounded-xl border border-slate-200 bg-white p-6">
          <h3 class="text-lg font-semibold text-slate-900">Inconsistent enforcement</h3>
          <p class="mt-2 text-slate-600">
            Violations and follow-ups slip through without clear ownership and timestamps.
          </p>
        </article>
        <article class="rounded-xl border border-slate-200 bg-white p-6">
          <h3 class="text-lg font-semibold text-slate-900">Resident frustration</h3>
          <p class="mt-2 text-slate-600">Homeowners donâ€™t know status, timelines, or who is handling their issue.</p>
        </article>
        <article class="rounded-xl border border-slate-200 bg-white p-6">
          <h3 class="text-lg font-semibold text-slate-900">Enterprise tool overload</h3>
          <p class="mt-2 text-slate-600">
            Most alternatives are bloated, expensive, and built for management companies.
          </p>
        </article>
      </div>
    </div>
  </section>

  <section class="max-w-7xl mx-auto px-4 sm:px-6 py-16 md:py-20">
    <div class="text-center max-w-3xl mx-auto">
      <p class="text-sm uppercase tracking-[0.2em] text-sky-600 font-semibold">How It Works</p>
      <h2 class="mt-3 text-3xl md:text-4xl font-bold text-slate-900">Three steps to a calmer HOA workflow</h2>
    </div>

    <div class="mt-12 grid md:grid-cols-3 gap-6">
      <article class="rounded-xl border border-slate-200 p-6">
        <p class="text-sm font-semibold text-sky-600">Step 1</p>
        <h3 class="mt-2 text-xl font-semibold text-slate-900">Residents submit</h3>
        <p class="mt-2 text-slate-600">Complaints and violation reports go into one portal with required context.</p>
      </article>
      <article class="rounded-xl border border-slate-200 p-6">
        <p class="text-sm font-semibold text-sky-600">Step 2</p>
        <h3 class="mt-2 text-xl font-semibold text-slate-900">Board triages</h3>
        <p class="mt-2 text-slate-600">Assign owners, set priority, and track outcomes through a shared board view.</p>
      </article>
      <article class="rounded-xl border border-slate-200 p-6">
        <p class="text-sm font-semibold text-sky-600">Step 3</p>
        <h3 class="mt-2 text-xl font-semibold text-slate-900">Everyone stays updated</h3>
        <p class="mt-2 text-slate-600">Automatic status updates reduce back-and-forth and improve trust.</p>
      </article>
    </div>
  </section>

  <section id="pricing" class="border-y border-slate-200 bg-slate-50/60">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 py-16 md:py-20">
      <div class="max-w-3xl">
        <p class="text-sm uppercase tracking-[0.2em] text-sky-600 font-semibold">Pricing Preview</p>
        <h2 class="mt-3 text-3xl md:text-4xl font-bold text-slate-900">Simple pricing for volunteer-led communities</h2>
      </div>

      <div class="mt-10 grid lg:grid-cols-2 gap-6">
        <article class="rounded-xl border border-slate-200 bg-white p-6">
          <p class="text-sm text-slate-500">Starter</p>
          <p class="mt-2 text-4xl font-bold text-slate-900">$49<span class="text-lg text-slate-500">/mo</span></p>
          <p class="mt-2 text-slate-600">Best for HOAs up to 100 units.</p>
          <ul class="mt-4 space-y-2 text-slate-700 list-disc pl-5">
            <li>Complaint tracking portal</li>
            <li>Violation workflow</li>
            <li>Automated resident updates</li>
          </ul>
        </article>
        <article class="rounded-xl border border-sky-300 bg-white p-6 shadow-sm">
          <p class="text-sm text-slate-500">Professional</p>
          <p class="mt-2 text-4xl font-bold text-slate-900">$99<span class="text-lg text-slate-500">/mo</span></p>
          <p class="mt-2 text-slate-600">Best for communities with 101-200 units.</p>
          <ul class="mt-4 space-y-2 text-slate-700 list-disc pl-5">
            <li>Everything in Starter</li>
            <li>Priority onboarding support</li>
            <li>Enhanced board reporting</li>
          </ul>
        </article>
      </div>
    </div>
  </section>

  <section class="max-w-4xl mx-auto px-4 sm:px-6 py-16 md:py-20">
    <div class="rounded-2xl border border-slate-200 bg-white p-8 sm:p-10 text-center shadow-sm">
      <p class="text-sm uppercase tracking-[0.2em] text-sky-600 font-semibold">Get Early Access</p>
      <h2 class="mt-3 text-3xl font-bold text-slate-900">Help shape HOA Connect before public launch</h2>
      <p class="mt-3 text-slate-600">
        Join the waitlist to get beta access, launch updates, and early pricing details.
      </p>

      <form class="js-waitlist-form mt-8 max-w-2xl mx-auto space-y-4" novalidate>
        <div class="grid sm:grid-cols-[1fr_auto] gap-3">
          <input
            name="email"
            type="email"
            autocomplete="email"
            required
            placeholder="board@yourhoa.org"
            class="w-full rounded-lg border border-slate-300 px-4 py-3 text-slate-900 placeholder:text-slate-400 focus:border-sky-500 focus:outline-none"
          />
          <button
            type="submit"
            data-track-cta="waitlist_submit_footer"
            class="rounded-lg bg-sky-600 px-6 py-3 font-semibold text-white hover:bg-sky-500 disabled:opacity-60"
          >
            Request Invite
          </button>
        </div>
        <input type="hidden" name="role" value="board_member" />
        <input type="hidden" name="hoa_size" value="51-100" />
        <p class="js-form-message text-sm min-h-[1.25rem] text-slate-600" aria-live="polite"></p>
      </form>
    </div>
  </section>

  <script>
    const STORAGE_KEY = 'hoa_connect_first_touch_utm';
    const EMAIL_RE = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

    /**
     * @typedef {{
     *   email: string;
     *   role?: string;
     *   hoa_size?: string;
     *   utm_source?: string;
     *   utm_medium?: string;
     *   utm_campaign?: string;
     * }} WaitlistPayload
     */

    /**
     * @param {string} eventName
     * @param {Record<string, unknown>} [props]
     */
    const track = (eventName, props = {}) => {
      if (typeof window !== 'undefined' && typeof window.plausible === 'function') {
        window.plausible(eventName, { props });
      }
    };

    const captureFirstTouchUtm = () => {
      const params = new URLSearchParams(window.location.search);
      const next = {
        utm_source: params.get('utm_source') || undefined,
        utm_medium: params.get('utm_medium') || undefined,
        utm_campaign: params.get('utm_campaign') || undefined,
      };

      if (!next.utm_source && !next.utm_medium && !next.utm_campaign) {
        return;
      }

      if (!localStorage.getItem(STORAGE_KEY)) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(next));
      }
    };

    const getStoredUtm = () => {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        return raw ? JSON.parse(raw) : {};
      } catch {
        return {};
      }
    };

    const endpoint = (() => {
      const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL;
      return supabaseUrl ? `${supabaseUrl}/functions/v1/waitlist-signup` : '';
    })();

    const supabaseAnonKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;

    /**
     * @param {HTMLFormElement} form
     * @param {string} text
     * @param {'default' | 'error' | 'success'} [tone]
     */
    const setMessage = (form, text, tone = 'default') => {
      const el = form.querySelector('.js-form-message');
      if (!el) {
        return;
      }
      el.textContent = text;
      el.classList.remove('text-red-600', 'text-emerald-700', 'text-slate-600');
      if (tone === 'error') {
        el.classList.add('text-red-600');
      } else if (tone === 'success') {
        el.classList.add('text-emerald-700');
      } else {
        el.classList.add('text-slate-600');
      }
    };

    /**
     * @param {HTMLFormElement} form
     * @param {boolean} isSubmitting
     */
    const setSubmitting = (form, isSubmitting) => {
      const button = form.querySelector('button[type="submit"]');
      if (button) {
        button.disabled = isSubmitting;
      }
    };

    /**
     * @param {WaitlistPayload} payload
     * @param {string} anonKey
     */
    const submitWaitlist = async (payload, anonKey) => {
      const response = await fetch(endpoint, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          apikey: anonKey,
          Authorization: `Bearer ${anonKey}`,
        },
        body: JSON.stringify(payload),
      });

      const data = await response.json().catch(() => ({}));

      if (!response.ok) {
        return { ok: false, code: data?.code || 'SERVER_ERROR' };
      }

      return { ok: true, status: data?.status || 'created' };
    };

    const initWaitlistForms = () => {
      const forms = document.querySelectorAll<HTMLFormElement>('form.js-waitlist-form');
      if (!forms.length) {
        return;
      }

      track('waitlist_form_view', { path: window.location.pathname });

      forms.forEach((form) => {
        form.addEventListener('submit', async (event) => {
          event.preventDefault();

          const formData = new FormData(form);
          const email = String(formData.get('email') || '')
            .trim()
            .toLowerCase();
          const role = String(formData.get('role') || '').trim();
          const hoaSize = String(formData.get('hoa_size') || '').trim();

          if (!EMAIL_RE.test(email)) {
            setMessage(form, 'Enter a valid email address.', 'error');
            track('waitlist_error', { code: 'INVALID_EMAIL' });
            return;
          }

          if (!endpoint || !supabaseAnonKey) {
            setMessage(form, 'Signup is temporarily unavailable. Please try again soon.', 'error');
            track('waitlist_error', { code: 'CONFIG_MISSING' });
            return;
          }

          const utm = getStoredUtm();
          const payload = {
            email,
            role: role || undefined,
            hoa_size: hoaSize || undefined,
            utm_source: utm.utm_source,
            utm_medium: utm.utm_medium,
            utm_campaign: utm.utm_campaign,
          };

          setSubmitting(form, true);
          setMessage(form, 'Submitting...');
          track('waitlist_submit', { form: form.id || 'waitlist_form' });

          try {
            const result = await submitWaitlist(payload, supabaseAnonKey);

            if (!result.ok) {
              setMessage(form, 'Could not submit right now. Please try again.', 'error');
              track('waitlist_error', { code: result.code });
              return;
            }

            if (result.status === 'duplicate') {
              setMessage(form, 'You are already on the waitlist. We will keep you posted.', 'success');
            } else {
              setMessage(form, 'You are in. We will send launch updates to your inbox.', 'success');
              form.reset();
            }

            track('waitlist_success', { status: result.status });
          } catch {
            setMessage(form, 'Network error. Please try again in a moment.', 'error');
            track('waitlist_error', { code: 'NETWORK_ERROR' });
          } finally {
            setSubmitting(form, false);
          }
        });
      });
    };

    const initCtaTracking = () => {
      const ctas = document.querySelectorAll('[data-track-cta]');
      ctas.forEach((cta) => {
        cta.addEventListener('click', () => {
          const name = cta.getAttribute('data-track-cta') || 'unknown';
          track('cta_click_primary', { name });
        });
      });
    };

    captureFirstTouchUtm();
    initWaitlistForms();
    initCtaTracking();
  </script>
</PageLayout>
